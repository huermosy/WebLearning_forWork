# 基于矩阵数学的表格字段提取模型（小模型友好版）

## 核心思想

将表格视为二维矩阵 $T$，其中每个单元格 $T_{ij}$ 具有一系列属性。通过数学运算和模式识别，我们可以确定数据单元格和生成对应的键值。

## 表格的矩阵表示

### 单元格特征向量

每个单元格 $T_{ij}$ 可以表示为特征向量：

$$C_{ij} = [s_{ij}, p_{ij}, c_{ij}]$$

其中：
- $s_{ij}$ 为结构特征（位置、跨行跨列）
- $p_{ij}$ 为属性特征（是否为空、是否有数字等）
- $c_{ij}$ 为内容特征（文本语义）

### 表格类型识别函数

表格类型可以通过特征矩阵 $M_T$ 的特征进行判断：

$$type(T) = \begin{cases}
1 & \text{如果 } \exists T_{ij} : \text{diagonal-split} = true \\
2 & \text{如果 } |rows(T)| = 1 \text{ 且 } |cells(T)| \text{ 为偶数} \\
3 & \text{如果 } \exists T_{ij} : colspan(T_{ij}) > 1 \text{ 且满足键值对模式} \\
4 & \text{如果 } header(row_1) \text{ 且 } header(col_1) \\
5 & \text{如果只有 } header(col_1) \\
6 & \text{其他情况}
\end{cases}$$

## 表格类型特征

### 1. 对角线表头表格

**数学特征**：
- 存在单元格 $T_{rc}$ 满足 diagonal-split = true
- 数据单元格集合 $D = \{T_{ij} | i > r \text{ 且 } j > c\}$
- 键生成函数：$key(T_{ij}) = text(T_{rj}) + \text{"\_"} + text(T_{ic})$

### 2. 单行键值对表格

**数学特征**：
- $|rows(T)| = 1$
- $|cells(T)| \mod 2 = 0$ (单元格数量为偶数)
- 数据单元格集合 $D = \{T_{0,j} | j \mod 2 = 1\}$ (偶数位置的单元格)
- 键生成函数：$key(T_{0,j}) = text(T_{0,j-1})$

### 3. 多行键值对表格

**数学特征**：
- 存在行 $r$ 使得 $colspan(T_{r,0}) > 1$ (有标题行)
- 对于非标题行 $i$，$|cells(row_i)| = 2$ 或者偶数且遵循键值对模式
- 数据单元格集合 $D = \{T_{ij} | i \notin title\_rows \text{ 且 } j \mod 2 = 1\}$
- 键生成函数：$key(T_{ij}) = text(T_{i,j-1})$

### 4. 标准网格表格

**数学特征**：
- 第一行的单元格都是标题：$\forall j, is\_header(T_{0,j}) = true$
- 第一列的单元格都是标题：$\forall i, is\_header(T_{i,0}) = true$
- 数据单元格集合 $D = \{T_{ij} | i > 0 \text{ 且 } j > 0\}$
- 键生成函数：$key(T_{ij}) = text(T_{0,j}) + \text{"\_"} + text(T_{i,0})$

### 5. 列标题表格

**数学特征**：
- 只有第一列的单元格是标题：$\forall i, is\_header(T_{i,0}) = true$
- 其他列不是标题：$\forall i > 0, \forall j > 0, is\_header(T_{i,j}) = false$
- 数据单元格集合 $D = \{T_{ij} | j > 0\}$
- 键生成函数：$key(T_{ij}) = text(T_{i,0})$

## 单元格分类方法

### 头部单元格识别

一个单元格 $T_{ij}$ 是头部单元格的概率可以表示为：

$$P(header|T_{ij}) = \sigma(w_1 \cdot s_{ij} + w_2 \cdot p_{ij} + w_3 \cdot c_{ij})$$

其中 $\sigma$ 是sigmoid函数，$w_1, w_2, w_3$ 是权重向量。

简化为自然语言规则：
1. 如果单元格跨行或跨列（colspan > 1 或 rowspan > 1），则很可能是标题
2. 如果单元格在第一行或第一列，则很可能是标题
3. 如果单元格内容是描述性文本而非数值，则很可能是标题

### 数据单元格识别

一个单元格 $T_{ij}$ 是数据单元格的概率：

$$P(data|T_{ij}) = 1 - P(header|T_{ij}) + P(contextual\_data|T_{ij})$$

其中 $P(contextual\_data|T_{ij})$ 是基于上下文的额外证据，如：
- 单元格在数据区域内
- 单元格包含数字或为空
- 单元格的左侧或上方有标题单元格

## 表格类型确定的决策树

简化为自然语言描述的决策过程：

1. **检查对角线特性**：矩阵中是否存在带有对角线分隔属性的单元格？
   - 如果有 → 对角线表头表格
   - 如果没有 → 继续检查

2. **检查行数和单元格数**：矩阵是否只有一行且单元格数为偶数？
   - 如果是 → 单行键值对表格
   - 如果不是 → 继续检查

3. **检查键值对模式**：排除标题行后，剩余行是否形成键值对模式？
   - 如果是 → 多行键值对表格
   - 如果不是 → 继续检查

4. **检查行列标题**：第一行和第一列是否都包含标题？
   - 如果是 → 标准网格表格
   - 如果不是 → 继续检查

5. **检查列标题**：是否只有第一列包含标题？
   - 如果是 → 列标题表格
   - 如果不是 → 特殊形式表格

## 小模型的处理流程

为了让10B小模型能够正确处理表格提取任务，我们简化为以下步骤：

1. **结构解析**：将HTML表格转换为矩阵表示
   - 提取行、列、跨行跨列信息
   - 检测特殊属性（如对角线分隔）

2. **表格类型判断**：严格按照上述决策树顺序检查
   - 每种类型有明确的数学特征
   - 一旦满足某类型条件立即确定

3. **数据单元格标识**：根据表格类型应用相应规则
   - 使用确定性的位置关系判断
   - 对每个单元格应用布尔逻辑条件

4. **键生成**：使用表格类型对应的键生成函数
   - 键生成是确定性的映射关系
   - 不添加任何推测性内容

## 应用实例

以多行键值对表格为例：

$$T = \begin{pmatrix}
\text{"Measurements"} & colspan=2 \\
\text{"Sp1"} & \text{"29.3℃"} \\
\text{"Bx1"} & \text{""} \\
\text{"Max"} & \text{"35.8℃"}
\end{pmatrix}$$

应用我们的算法：
1. 检测到第一行有colspan=2，是标题行
2. 剩余行形成键值对模式（每行有标签和数据）
3. 数据单元格是第2、3、4行的第2列
4. 键生成：使用同行第1列的文本
   - $key(T_{1,1}) = text(T_{1,0}) = \text{"Sp1"}$
   - $key(T_{2,1}) = text(T_{2,0}) = \text{"Bx1"}$
   - $key(T_{3,1}) = text(T_{3,0}) = \text{"Max"}$

## 优化推理的数学模型

对于10B小模型，我们可以进一步简化判断逻辑为矩阵运算：

1. **表格特征向量**：$F(T) = [f_1, f_2, f_3, f_4, f_5]$
   - $f_1$ = 是否存在对角线分隔单元格
   - $f_2$ = 行数是否为1且单元格数为偶数
   - $f_3$ = 是否存在标题行且剩余行为键值对
   - $f_4$ = 第一行和第一列是否都是标题
   - $f_5$ = 是否只有第一列是标题

2. **类型判断**：$type(T) = \text{argmax}_i(F(T) \cdot W)$，其中权重矩阵 $W$ 为单位矩阵，表示严格按顺序检查

3. **数据单元格标识矩阵**：$D_{ij} = f(type(T), i, j)$
   - 对于每种表格类型，有确定的函数判断单元格$(i,j)$是否为数据单元格

4. **键生成函数**：$K_{ij} = g(type(T), T, i, j)$
   - 对于每种类型，有确定的函数生成数据单元格的键

最终，输出结果为：
$$R = \{(id(T_{ij}), K_{ij}) | D_{ij} = 1\}$$

这种数学建模方法将复杂的表格分析转化为确定性的矩阵运算，特别适合计算能力有限的小模型。通过明确的数学规则和有序的判断流程，可以大幅提高小模型推理的准确性和一致性。
